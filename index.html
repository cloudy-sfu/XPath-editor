<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XPath Evaluator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <!-- Code mirror -->
    <script src="/codemirror/codemirror.js"></script>
    <link rel="stylesheet" href="/codemirror/codemirror.css" />
    <script src="/codemirror/xml.js"></script>
</head>
<body class="container-md">
<div class="row alert">
    <div class="col-md-8">
        <label for="xml-editor-in" class="form-label">Input XML text</label>
        <textarea id="xml-editor-in" rows="10"></textarea>
        <div class="my-4"></div>
        <p>Or attach XML file </p>
        <input class="link-dark rounded" id="fileInput" accept="text/xml" type="file" name="file" />
        <div class="my-4"></div>
        <label for="xml-editor-out" class="form-label">Retrieved XML nodes (1 query result, 1 line)</label>
        <textarea id="xml-editor-out" rows="10"></textarea>
        <script>
            const xml_in_editor = CodeMirror.fromTextArea(document.getElementById("xml-editor-in"), {
                mode: "xml",
                lineNumbers: true,
                theme: "default",
            });
            xml_in_editor.setSize(null, xml_in_editor.defaultTextHeight() * 10.5);
            const xml_out_editor = CodeMirror.fromTextArea(document.getElementById("xml-editor-out"), {
                mode: "xml",
                lineNumbers: true,
                theme: "default",
            });
            xml_out_editor.setSize(null, xml_out_editor.defaultTextHeight() * 10.5);
        </script>
    </div>
    <div class="col-md-4">
        <label for="source-switch" class="form-label">Source</label>
        <select class="form-select" id="source-switch" onchange="source_switch()">
            <option selected value="1">Text area</option>
            <option value="2">Uploaded file</option>
        </select>
        <script>
            let xml_source = 1;
            function source_switch() {
                xml_source = Number(document.getElementById("source-switch").value);
            }
        </script>
        <div class="my-4"></div>
        <label for="xpath-editor" class="form-label">XPath</label>
        <textarea id="xpath-editor" rows="2"></textarea>
        <script>
            const xpath_editor = CodeMirror.fromTextArea(document.getElementById("xpath-editor"), {
                mode: "xml",
                theme: "default",
                lineWrapping: true,
                lineNumbers: true,
            });
            xpath_editor.setSize(null, xpath_editor.defaultTextHeight() * 2.5);  // 2 lines height (+0.5)
        </script>
        <div class="text-center alert">
            <button class="btn border-dark text-nowrap" onclick="evaluate_all()">Evaluate XPath</button>
        </div>
        <script>
            const dom_parser = new DOMParser();
            const xml_parser = new XMLSerializer();
            let xml = null;
            function evaluate_xpath(xpath, xml) {
                const xml_document = dom_parser.parseFromString(xml, "application/xml");
                const result_generator = document.evaluate(xpath, xml_document, null, XPathResult.ANY_TYPE, null);
                let results = [];
                let result = result_generator.iterateNext();
                while (result != null) {
                    results.push(result);
                    result = result_generator.iterateNext();
                }
                return results
            }
            // Specially designed, force <a></a> instead of <a />.
            // function node_to_string(node) {
            //     let wrapper = document.createElement('div');
            //     wrapper.appendChild(node);
            //     return wrapper.innerHTML.replaceAll("\n", "\\n")
            // }
            function evaluate_all() {
                const xpath = xpath_editor.getValue();
                if (document.getElementById('source-switch').value === '1') {
                    xml = xml_in_editor.getValue();
                }
                const xml_results = evaluate_xpath(xpath, xml);
                xml_out_editor.setValue('');
                for (const result of xml_results) {
                    xml_out_editor.replaceRange(
                        xml_parser.serializeToString(result).replaceAll("\n", "\\n"),
                        CodeMirror.Pos(xml_out_editor.lastLine()));
                    xml_out_editor.replaceRange('\n', CodeMirror.Pos(xml_out_editor.lastLine()));
                }
            }
            function handleFileSelect(event) {
                const reader = new FileReader();
                reader.onload = (event) => {xml = event.target.result};
                reader.readAsText(event.target.files[0]);
            }
            document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
        </script>
    </div>
</div>
<div class="navbar"></div>
<div class="navbar fixed-bottom mx-4">
    <p class="text-muted"><small>&copy; cloudy-sfu 2023</small></p>
</div>
</body>
</html>